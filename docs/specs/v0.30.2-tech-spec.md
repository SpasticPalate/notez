# Tech Spec: v0.30.2 Bug Fixes & Folder UX Enhancement

**Version:** 0.30.2
**Date:** 2025-11-30
**Status:** Approved - Ready for Implementation

---

## Executive Summary

This release addresses four issues identified in v0.30.1:

1. **Folder icons not showing in dropdown** - Incomplete implementation
2. **Folder counts not updating** - Missing state refresh after folder changes
3. **Live updates not working** - Clarification: No real-time system exists (by design)
4. **Clunky folder selection UX** - Replace dropdown with modern chip component

**Scope:** Frontend-only changes. No backend modifications required.

---

## Issue Analysis

### Bug #1: Folder Icons Not in Dropdown

**Root Cause:** The `NoteEditor.tsx` component uses a native HTML `<select>` element which cannot render custom content like icons. Additionally, the `FolderData` interface in NoteEditor is missing the `icon` field.

**Current Code:** [NoteEditor.tsx:415-433](frontend/src/components/NoteEditor.tsx#L415-L433)
```typescript
<select value={selectedFolderId || ''} onChange={...}>
  <option value="">Unfiled</option>
  {folders.map((folder) => (
    <option key={folder.id} value={folder.id}>
      {folder.name}  // No icon possible in <option>
    </option>
  ))}
</select>
```

**Fix:** This will be resolved by implementing the Folder Chip component (Bug #4), which replaces the `<select>` entirely.

---

### Bug #2: Folder Counts Not Updating

**Root Cause:** When a note's folder is changed via the editor dropdown, `sidebarRef.current?.refreshFolders()` is never called. The refresh only happens for:
- Note creation ([EditorPage.tsx:161](frontend/src/pages/EditorPage.tsx#L161))
- Note deletion ([EditorPage.tsx:178](frontend/src/pages/EditorPage.tsx#L178))
- Note restoration ([EditorPage.tsx:190](frontend/src/pages/EditorPage.tsx#L190))
- Drag-and-drop in sidebar ([FolderSidebar.tsx:247](frontend/src/components/FolderSidebar.tsx#L247))

**Missing Integration:** [NoteEditor.tsx:162-168](frontend/src/components/NoteEditor.tsx#L162-L168) notifies parent of folder changes, but parent only updates note list, not sidebar.

**Fix:** Add callback to trigger sidebar refresh when folder changes.

---

### Bug #3: State Not Propagating Across Components

**Clarification:** This is not about WebSocket/real-time sync. The issue is that when changes are made in one component, other components that should reflect those changes don't update until page refresh.

**Specific Scenarios:**

| Action | What SHOULD Update | What Currently Updates |
|--------|-------------------|----------------------|
| Move note to folder (editor) | Sidebar folder counts, Note list | Note list only |
| Move note to folder (drag/drop) | Sidebar counts, Note list | Both âœ“ |
| Add/remove tag (editor) | Sidebar tag counts | Not updating |
| Create new note | Sidebar counts, Note list | Both âœ“ |
| Delete note | Sidebar counts, Note list | Both âœ“ |

**Root Cause:** Missing refresh callbacks after certain state changes. The `sidebarRef.current?.refreshFolders()` and `refreshTags()` methods exist but aren't called in all necessary places.

**Fix:** Add proper callback chains to trigger sidebar refresh after folder/tag changes in editor.

---

### Bug #4: Folder Chip UX (Enhancement)

**Current UX Pain Points:**
1. Native `<select>` looks dated
2. No folder icons visible
3. No visual indication of current folder at a glance
4. Requires two clicks (open dropdown, select)
5. Disconnected from sidebar (can't drag)

**Proposed Solution:** Replace dropdown with a "Folder Chip" component inspired by the existing `TagInput.tsx` pattern.

**Design:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Heroku alternative                         Saved 11:34 AM   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ“ homelab  â–¼     ðŸ·ï¸ tag1  ðŸ·ï¸ tag2  + Add tags...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      Folder Chip (clickable, shows icon + name + dropdown arrow)
```

**Interaction:**
- **Display:** Shows folder icon + folder name as a compact chip
- **Click:** Opens dropdown/popover with folder list (icons + names)
- **Unfiled:** Shows generic folder icon with "Unfiled" text
- **Keyboard:** Arrow keys navigate, Enter selects, Escape closes

---

## Technical Design

### New Component: FolderChip

**File:** `frontend/src/components/FolderChip.tsx`

```typescript
interface FolderChipProps {
  folders: FolderData[];
  selectedFolderId: string | null;
  onChange: (folderId: string | null) => void;
  disabled?: boolean;
}

interface FolderData {
  id: string;
  name: string;
  icon: string;
  noteCount: number;
}
```

**Features:**
1. Displays current folder as chip with icon
2. Click opens custom dropdown (not native `<select>`)
3. Dropdown shows all folders with icons and names
4. Supports keyboard navigation
5. Click outside closes dropdown
6. Dark mode support (existing Tailwind classes)

**Reference Pattern:** [TagInput.tsx](frontend/src/components/TagInput.tsx) - uses similar dropdown/popover pattern

**Existing Asset:** [FolderIcon component](frontend/src/components/FolderIconPicker.tsx#L133-L142) - reuse for icon rendering

---

### State Management Changes

**File:** `frontend/src/pages/EditorPage.tsx`

**Current:**
```typescript
onNoteUpdated={(noteId, updates) => {
  noteListRef.current?.updateNote(noteId, updates);
}}
```

**Updated:**
```typescript
onNoteUpdated={(noteId, updates) => {
  noteListRef.current?.updateNote(noteId, updates);
  // Refresh folder counts if folder changed
  if (updates.folderId !== undefined) {
    sidebarRef.current?.refreshFolders();
  }
}}
```

---

### Interface Updates

**File:** `frontend/src/components/NoteEditor.tsx`

**Current FolderData (missing icon):**
```typescript
interface FolderData {
  id: string;
  name: string;
  noteCount: number;
}
```

**Updated:**
```typescript
interface FolderData {
  id: string;
  name: string;
  icon: string;  // Added
  noteCount: number;
}
```

---

## Implementation Plan

### Story 1: Comprehensive State Propagation

**Complexity:** Medium

**Files:**

- [EditorPage.tsx](frontend/src/pages/EditorPage.tsx)
- [NoteEditor.tsx](frontend/src/components/NoteEditor.tsx)

**Acceptance Criteria:**

- [ ] Move note to folder (editor) â†’ sidebar folder counts update immediately
- [ ] Move note to folder (editor) â†’ note list reflects new folder
- [ ] Move note to unfiled (editor) â†’ sidebar "Unfiled" count updates
- [ ] Add/remove tag (editor) â†’ sidebar tag counts update immediately
- [ ] All updates happen without page refresh
- [ ] On API failure â†’ show error, no incorrect counts displayed

---

### Story 2: Create FolderChip Component
**Complexity:** Medium
**Files:**
- `frontend/src/components/FolderChip.tsx` (new)
- [NoteEditor.tsx](frontend/src/components/NoteEditor.tsx)

**Acceptance Criteria:**
- [ ] Chip displays folder icon + name
- [ ] Click opens dropdown with all folders (icons + names)
- [ ] "Unfiled" option at top with generic folder icon
- [ ] Selecting folder updates chip and triggers onChange
- [ ] Keyboard navigation: Arrow keys, Enter, Escape
- [ ] Click outside closes dropdown
- [ ] Dark mode styling matches existing components
- [ ] Disabled state prevents interaction (for deleted notes)

---

### Story 3: Update FolderData Interface & Integration
**Complexity:** Low
**Files:**
- [NoteEditor.tsx](frontend/src/components/NoteEditor.tsx)

**Acceptance Criteria:**
- [ ] FolderData interface includes `icon` field
- [ ] Folder data from API includes icons
- [ ] FolderChip receives complete folder data

---

### Story 4: Expand Folder Icon Set

**Complexity:** Low

**Files:**

- [FolderIconPicker.tsx](frontend/src/components/FolderIconPicker.tsx)
- [validation.schemas.ts](backend/src/utils/validation.schemas.ts)

**New Icons to Add:**

- `palette` - Art, creative projects
- `paintbrush` - Art, design work
- `pencil` - Sketches, drafts, writing
- `pen` - Writing, journaling
- `pen-tool` - Design, vectors
- `flower-2` - Nature, garden
- `drama` - Theater, entertainment
- `coffee` - Recipes, lifestyle
- `utensils` - Cooking, recipes
- `gift` - Occasions, wishlist

**Acceptance Criteria:**

- [ ] All new icons added to FOLDER_ICON_MAP
- [ ] Backend Zod validation updated to accept new icon names
- [ ] Icons render correctly in sidebar, picker, and FolderChip

---

## Testing Checklist

### Manual Testing
- [ ] Change note folder via chip â†’ sidebar counts update
- [ ] Change note folder via chip â†’ note list shows correct folder
- [ ] Click chip â†’ dropdown appears with icons
- [ ] Select folder â†’ chip updates with new icon/name
- [ ] Select "Unfiled" â†’ chip shows "Unfiled" with folder icon
- [ ] Press Escape â†’ dropdown closes
- [ ] Click outside â†’ dropdown closes
- [ ] Arrow keys navigate dropdown
- [ ] Enter selects highlighted option
- [ ] Deleted note â†’ chip is disabled
- [ ] Dark mode â†’ all styling correct

### Edge Cases
- [ ] Many folders (20+) â†’ dropdown scrolls
- [ ] Long folder names â†’ truncate with ellipsis
- [ ] Rapid folder changes â†’ no race conditions
- [ ] API error on folder load â†’ graceful fallback

---

## Files Changed Summary

| File | Change Type | Description |
|------|-------------|-------------|
| `frontend/src/components/FolderChip.tsx` | New | Folder selection chip component |
| `frontend/src/components/NoteEditor.tsx` | Modified | Replace select with FolderChip, update interface |
| `frontend/src/pages/EditorPage.tsx` | Modified | Add sidebar refresh on folder change |
| `docs/known-issues.md` | Modified | Document real-time behavior |

---

## Out of Scope

- WebSocket/real-time sync (multi-user)
- Drag-and-drop from note editor to sidebar
- Folder creation from chip dropdown
- Multi-select folders

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| FolderChip styling inconsistent | Low | Low | Follow TagInput.tsx patterns exactly |
| Performance with many folders | Low | Medium | Virtual scrolling if >50 folders (unlikely) |
| Keyboard accessibility gaps | Medium | Medium | Test with screen reader, follow TagInput patterns |

---

## Approval

- [x] Product Owner approval (2025-11-30)
- [x] Ready for implementation

---

**Prepared by:** The Party Mode Team

- **Mary** (Analyst)
- **Winston** (Architect)
- **Amelia** (Dev)
- **Sally** (UX)
- **Bob** (SM)
- **Murat** (Test)
